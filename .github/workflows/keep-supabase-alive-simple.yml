name: Keep Supabase DB Alive

on:
  schedule:
    - cron: "0 */8 * * *"
  workflow_dispatch:

jobs:
  ping-supabase:
    runs-on: ubuntu-latest
    steps:
      - name: Ping Supabase (debug + keep alive)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          set -euo pipefail

          # Normalize secrets
          SUPABASE_URL="$(printf "%s" "$SUPABASE_URL" | tr -d '\r\n' | sed 's:/*$::')"
          SUPABASE_ANON_KEY="$(printf "%s" "$SUPABASE_ANON_KEY" | tr -d '\r\n')"

          echo "üîÑ $(date)"
          echo "üîé URL: $SUPABASE_URL"
          echo "üîé Key length: ${#SUPABASE_ANON_KEY}"
          echo "üîé Key prefix: $(printf "%s" "$SUPABASE_ANON_KEY" | cut -c1-12)..."

          AUTH_HEADER="Authorization: Bearer $SUPABASE_ANON_KEY"
          API_HEADER="apikey: $SUPABASE_ANON_KEY"

          # Show only the start of the header so we can confirm 'Authorization: Bearer' is present
          echo "üîé Auth header prefix: $(printf "%s" "$AUTH_HEADER" | cut -c1-22)..."

          echo "‚û°Ô∏è Test 1: Auth service health (verifies URL/key are sane)"
          HEALTH_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "$API_HEADER" \
            "$SUPABASE_URL/auth/v1/health")

          echo "auth/v1/health => HTTP $HEALTH_CODE"

          echo "‚û°Ô∏è Test 2: PostgREST keep_alive table"
          REST_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "$API_HEADER" \
            -H "$AUTH_HEADER" \
            "$SUPABASE_URL/rest/v1/keep_alive?select=id&limit=1")

          echo "rest/v1/keep_alive => HTTP $REST_CODE"

          if [ "$REST_CODE" != "200" ]; then
            echo "‚ùå keep_alive failed. Printing response body for clues:"
            curl -s \
              -H "$API_HEADER" \
              -H "$AUTH_HEADER" \
              "$SUPABASE_URL/rest/v1/keep_alive?select=id&limit=1" || true
            exit 1
          fi

          echo "‚úÖ Supabase database kept alive successfully"
