- name: Keep Supabase database alive
  env:
    SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
    SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
  run: |
    set -euo pipefail

    SUPABASE_URL="$(printf "%s" "$SUPABASE_URL" | tr -d '\r\n' | sed 's:/*$::')"
    SUPABASE_ANON_KEY="$(printf "%s" "$SUPABASE_ANON_KEY" | tr -d '\r\n')"

    CODE=$(curl -s -o /dev/null -w "%{http_code}" \
      -H "apikey: $SUPABASE_ANON_KEY" \
      -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
      "$SUPABASE_URL/rest/v1/keep_alive?select=id&limit=1")

    if [ "$CODE" != "200" ]; then
      echo "❌ keep_alive failed (HTTP $CODE)"
      exit 1
    fi

    echo "✅ Supabase keep-alive OK (HTTP $CODE) at $(date)"
